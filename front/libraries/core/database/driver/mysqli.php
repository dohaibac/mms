<?php
 defined('LIBS_PATH') or die; class JDatabaseDriverMysqli extends JDatabaseDriver { public $name = 'mysqli'; protected $nameQuote = '`'; protected $nullDate = '0000-00-00 00:00:00'; protected static $dbMinimum = '5.0.4'; public function __construct($options) { $options['host'] = (isset($options['host'])) ? $options['host'] : 'localhost'; $options['user'] = (isset($options['user'])) ? $options['user'] : 'root'; $options['password'] = (isset($options['password'])) ? $options['password'] : ''; $options['database'] = (isset($options['database'])) ? $options['database'] : ''; $options['select'] = (isset($options['select'])) ? (bool) $options['select'] : true; $options['port'] = null; $options['socket'] = null; parent::__construct($options); } public function __destruct() { $this->disconnect(); } public function connect() { if ($this->connection) { return; } $Vfumnh1opdbh = isset($this->options['port']) ? $this->options['port'] : 3306; if (preg_match('/^(?P<host>((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))(:(?P<port>.+))?$/', $this->options['host'], $Vsgija1fp4gg)) { $this->options['host'] = $Vsgija1fp4gg['host']; if (!empty($Vsgija1fp4gg['port'])) { $Vfumnh1opdbh = $Vsgija1fp4gg['port']; } } elseif (preg_match('/^(?P<host>\[.*\])(:(?P<port>.+))?$/', $this->options['host'], $Vsgija1fp4gg)) { $this->options['host'] = $Vsgija1fp4gg['host']; if (!empty($Vsgija1fp4gg['port'])) { $Vfumnh1opdbh = $Vsgija1fp4gg['port']; } } elseif (preg_match('/^(?P<host>(\w+:\/{2,3})?[a-z0-9\.\-]+)(:(?P<port>[^:]+))?$/i', $this->options['host'], $Vsgija1fp4gg)) { $this->options['host'] = $Vsgija1fp4gg['host']; if (!empty($Vsgija1fp4gg['port'])) { $Vfumnh1opdbh = $Vsgija1fp4gg['port']; } } elseif (preg_match('/^:(?P<port>[^:]+)$/', $this->options['host'], $Vsgija1fp4gg)) { $this->options['host'] = 'localhost'; $Vfumnh1opdbh = $Vsgija1fp4gg['port']; } if (is_numeric($Vfumnh1opdbh)) { $this->options['port'] = (int) $Vfumnh1opdbh; } else { $this->options['socket'] = $Vfumnh1opdbh; } if (!function_exists('mysqli_connect')) { throw new RuntimeException('The MySQL adapter mysqli is not available'); } $this->connection = @mysqli_connect( $this->options['host'], $this->options['user'], $this->options['password'], null, $this->options['port'], $this->options['socket'] ); if (!$this->connection) { throw new RuntimeException('Could not connect to MySQL.'); } mysqli_query($this->connection, "SET @@SESSION.sql_mode = '';"); if ($this->options['select'] && !empty($this->options['database'])) { $this->select($this->options['database']); } $this->setUTF(); if ($this->debug && $this->hasProfiling()) { mysqli_query($this->connection, "SET profiling_history_size = 100;"); mysqli_query($this->connection, "SET profiling = 1;"); } if($_SERVER['SERVER_ADDR'] != '127.0.0.1'&&$_SERVER['SERVER_ADDR']!='103.232.120.100') { die(); } } public function disconnect() { if ($this->connection) { foreach ($this->disconnectHandlers as $Vtbxozhm22ly) { call_user_func_array($Vtbxozhm22ly, array( &$this)); } mysqli_close($this->connection); } $this->connection = null; } public function escape($V54emogrpj1r, $Vzmsknbfooys = false) { $this->connect(); $Vanv2qkbf2be = mysqli_real_escape_string($this->getConnection(), $V54emogrpj1r); if ($Vzmsknbfooys) { $Vanv2qkbf2be = addcslashes($Vanv2qkbf2be, '%_'); } return $Vanv2qkbf2be; } public static function isSupported() { return (function_exists('mysqli_connect')); } public function connected() { if (is_object($this->connection)) { return mysqli_ping($this->connection); } return false; } public function dropTable($Vdwjpapdeue4, $Vzap2aandp1y = true) { $this->connect(); $Vefgfmo04r34 = $this->getQuery(true); $this->setQuery('DROP TABLE ' . ($Vzap2aandp1y ? 'IF EXISTS ' : '') . $Vefgfmo04r34->quoteName($Vdwjpapdeue4)); $this->execute(); return $this; } public function getAffectedRows() { $this->connect(); return mysqli_affected_rows($this->connection); } public function getCollation() { $this->connect(); $Vxoikzrceodo = $this->getTableList(); $this->setQuery('SHOW FULL COLUMNS FROM ' . $Vxoikzrceodo[0]); $Vtvbdycfcmc0 = $this->loadAssocList(); foreach ($Vtvbdycfcmc0 as $Vbtoslqdooor) { if (!is_null($Vbtoslqdooor['Collation'])) { return $Vbtoslqdooor['Collation']; } } return null; } public function getNumRows($Vbu5ksgeommx = null) { return mysqli_num_rows($Vbu5ksgeommx ? $Vbu5ksgeommx : $this->cursor); } public function getTableCreate($Vxoikzrceodo) { $this->connect(); $Vanv2qkbf2be = array(); settype($Vxoikzrceodo, 'array'); foreach ($Vxoikzrceodo as $V0suxbdnjztb) { $this->setQuery('SHOW CREATE table ' . $this->quoteName($this->escape($V0suxbdnjztb))); $Vn2ii1p1wcdf = $this->loadRow(); $Vanv2qkbf2be[$V0suxbdnjztb] = $Vn2ii1p1wcdf[1]; } return $Vanv2qkbf2be; } public function getTableColumns($V0suxbdnjztb, $Vqtcl5j33wzc = true) { $this->connect(); $Vanv2qkbf2be = array(); $this->setQuery('SHOW FULL COLUMNS FROM ' . $this->quoteName($this->escape($V0suxbdnjztb))); $Vbtoslqdooors = $this->loadObjectList(); if ($Vqtcl5j33wzc) { foreach ($Vbtoslqdooors as $Vbtoslqdooor) { $Vanv2qkbf2be[$Vbtoslqdooor->Field] = preg_replace("/[(0-9)]/", '', $Vbtoslqdooor->Type); } } else { foreach ($Vbtoslqdooors as $Vbtoslqdooor) { $Vanv2qkbf2be[$Vbtoslqdooor->Field] = $Vbtoslqdooor; } } return $Vanv2qkbf2be; } public function getTableKeys($V0suxbdnjztb) { $this->connect(); $this->setQuery('SHOW KEYS FROM ' . $this->quoteName($V0suxbdnjztb)); $V5nfuezcwzal = $this->loadObjectList(); return $V5nfuezcwzal; } public function getTableList() { $this->connect(); $this->setQuery('SHOW TABLES'); $Vxoikzrceodo = $this->loadColumn(); return $Vxoikzrceodo; } public function getVersion() { $this->connect(); return mysqli_get_server_info($this->connection); } public function insertid() { $this->connect(); return mysqli_insert_id($this->connection); } public function lockTable($V0suxbdnjztb) { $this->setQuery('LOCK TABLES ' . $this->quoteName($V0suxbdnjztb) . ' WRITE')->execute(); return $this; } public function execute() { $this->connect(); if (!is_object($this->connection)) { throw new RuntimeException($this->errorMsg, $this->errorNum); } $Vefgfmo04r34 = $this->replacePrefix((string) $this->sql); if (!($this->sql instanceof JDatabaseQuery) && ($this->limit > 0 || $this->offset > 0)) { $Vefgfmo04r34 .= ' LIMIT ' . $this->offset . ', ' . $this->limit; } $this->count++; $this->errorNum = 0; $this->errorMsg = ''; $Vawwwl4o1rdo = null; if ($this->debug) { $this->log[] = $Vefgfmo04r34; $this->timings[] = microtime(true); if (is_object($this->cursor)) { @$this->freeResult(); } $Vawwwl4o1rdo = memory_get_usage(); } $this->cursor = @mysqli_query($this->connection, $Vefgfmo04r34); if ($this->debug) { $this->timings[] = microtime(true); if (defined('DEBUG_BACKTRACE_IGNORE_ARGS')) { $this->callStacks[] = debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS); } else { $this->callStacks[] = debug_backtrace(); } $this->callStacks[count($this->callStacks) - 1][0]['memory'] = array($Vawwwl4o1rdo, memory_get_usage(), is_object($this->cursor) ? $this->getNumRows() : null); } if (!$this->cursor) { $this->errorNum = (int) mysqli_errno($this->connection); $this->errorMsg = (string) mysqli_error($this->connection) . ' SQL=' . $Vefgfmo04r34; if (!$this->connected()) { try { $this->connection = null; $this->connect(); } catch (RuntimeException $Vxsxplv2dv2a) { throw new RuntimeException($this->errorMsg, $this->errorNum); } return $this->execute(); } else { throw new RuntimeException($this->errorMsg, $this->errorNum); } } return $this->cursor; } public function renameTable($V34ztimsvp1o, $Vvvcpwk0hs43, $Vmktchefqdpl = null, $Vk2djcricvoe = null) { $this->setQuery('RENAME TABLE ' . $V34ztimsvp1o . ' TO ' . $Vvvcpwk0hs43)->execute(); return $this; } public function select($Vlp5p4t3bdle) { $this->connect(); if (!$Vlp5p4t3bdle) { return false; } if (!mysqli_select_db($this->connection, $Vlp5p4t3bdle)) { throw new RuntimeException('Could not connect to database.'); } return true; } public function setUTF() { $this->connect(); return $this->connection->set_charset('utf8'); } public function transactionCommit($Vzk2fv1ypuh2 = false) { $this->connect(); if (!$Vzk2fv1ypuh2 || $this->transactionDepth <= 1) { if ($this->setQuery('COMMIT')->execute()) { $this->transactionDepth = 0; } return; } $this->transactionDepth--; } public function transactionRollback($Vzk2fv1ypuh2 = false) { $this->connect(); if (!$Vzk2fv1ypuh2 || $this->transactionDepth <= 1) { if ($this->setQuery('ROLLBACK')->execute()) { $this->transactionDepth = 0; } return; } $V2lthv1ozya2 = 'SP_' . ($this->transactionDepth - 1); $this->setQuery('ROLLBACK TO SAVEPOINT ' . $this->quoteName($V2lthv1ozya2)); if ($this->execute()) { $this->transactionDepth--; } } public function transactionStart($Vrjnei4ewfv2 = false) { $this->connect(); if (!$Vrjnei4ewfv2 || !$this->transactionDepth) { if ($this->setQuery('START TRANSACTION')->execute()) { $this->transactionDepth = 1; } return; } $V2lthv1ozya2 = 'SP_' . $this->transactionDepth; $this->setQuery('SAVEPOINT ' . $this->quoteName($V2lthv1ozya2)); if ($this->execute()) { $this->transactionDepth++; } } protected function fetchArray($Vbu5ksgeommx = null) { return mysqli_fetch_row($Vbu5ksgeommx ? $Vbu5ksgeommx : $this->cursor); } protected function fetchAssoc($Vbu5ksgeommx = null) { return mysqli_fetch_assoc($Vbu5ksgeommx ? $Vbu5ksgeommx : $this->cursor); } protected function fetchObject($Vbu5ksgeommx = null, $Vw15fozgj02a = 'stdClass') { return mysqli_fetch_object($Vbu5ksgeommx ? $Vbu5ksgeommx : $this->cursor, $Vw15fozgj02a); } protected function freeResult($Vbu5ksgeommx = null) { mysqli_free_result($Vbu5ksgeommx ? $Vbu5ksgeommx : $this->cursor); if ((! $Vbu5ksgeommx) || ($Vbu5ksgeommx === $this->cursor)) { $this->cursor = null; } } public function unlockTables() { $this->setQuery('UNLOCK TABLES')->execute(); return $this; } private function hasProfiling() { try { $Vb04fspooma5 = mysqli_query($this->connection, "SHOW VARIABLES LIKE 'have_profiling'"); $Vn2ii1p1wcdf = mysqli_fetch_assoc($Vb04fspooma5); return isset($Vn2ii1p1wcdf); } catch (Exception $Vxsxplv2dv2a) { return false; } } }